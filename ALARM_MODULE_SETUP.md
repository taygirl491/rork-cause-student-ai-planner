# Alarm / “Real Alarm” MVP (expo-alarm-module) — Setup & Manual Test Guide

---

## IMPORTANT: AI-generated code & documentation (security disclaimer)

**This document and the code changes associated with it were generated by AI.**

They are provided **only for testing and as inspiration**, and **must not be copied 1:1 into production** without careful human review.

Using AI-generated code without a security review is risky because it may contain (non-exhaustive):
- **Security vulnerabilities** (e.g., unsafe permission usage, insecure defaults, leaking secrets, weak assumptions about OS behavior)
- **Reliability issues** (e.g., alarms not firing under Doze/OEM policies, incorrect time calculations, duplicate scheduling)
- **Incorrect platform behavior assumptions** (Android alarm/permission behavior changes across OS versions and OEMs)
- **Privacy and compliance issues** (over-broad permissions, unintended data collection/logging)

**If using any of this provided code in this pull request, you must**:
- Perform a **full security review** (including Android manifest permissions/components)
- Do a **threat model** appropriate for your app
- Validate behavior across **multiple Android versions and OEM devices**
- Ensure your org’s **legal/compliance** requirements are met

---

This document explains the MVP “real alarm” integration that was added to the app using [`expo-alarm-module`](https://www.npmjs.com/package/expo-alarm-module).

The goal is to schedule **date-specific alarms** using Android’s native alarm infrastructure (via the library), so alarms can **ring even if the app is not running** and **after reboot** (subject to device/OS policy).

---

## What was added / changed

### 1) Dependency + Expo plugin
- Added `expo-alarm-module` to `package.json`
- Added `"expo-alarm-module"` to the `plugins` array in `app.json`

### 2) AndroidManifest wiring (required by library)
Updated `android/app/src/main/AndroidManifest.xml` to include the permissions + receivers + service shown in the `expo-alarm-module` README:
- Permissions:
  - `android.permission.SCHEDULE_EXACT_ALARM`
  - `android.permission.RECEIVE_BOOT_COMPLETED`
  - `android.permission.FOREGROUND_SERVICE`
  - `android.permission.WAKE_LOCK`
  - `android.permission.POST_NOTIFICATIONS`
  - `android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK` (Android 14+ / SDK 34+)
  - (and `VIBRATE` already existed)
- Components:
  - `com.expoalarmmodule.receivers.AlarmReceiver`
  - `com.expoalarmmodule.receivers.BootReceiver`
  - `com.expoalarmmodule.receivers.NotificationActionReceiver`
  - `com.expoalarmmodule.AlarmService`

### 3) New wrapper module (app-level API)
Added `utils/alarmService.ts`:
- `scheduleTaskAlarm(task)` / `cancelTaskAlarm(taskId)`
- `scheduleDebugAlarmInTwoMinutes()` / `cancelDebugAlarm()`
- `stopAnyPlayingAlarm()`

Important implementation detail:
- Task alarms use `uid = task.id` (so updating/canceling uses the task id).
- If the task has no `dueTime`, we default to **09:00**, matching existing notification logic.

### 4) Integrated with task create/update/delete (MVP)
Updated `contexts/AppContext.tsx`:
- On task create/update:
  - If `alarmEnabled === true` and not completed:
    - cancel any existing native alarm for that task id
    - schedule a native alarm via `expo-alarm-module`
- On task delete:
  - cancel the native alarm for that task id

Also:
- If `alarmEnabled === true`, the code skips scheduling the “due date” local notification from `expo-notifications` to reduce duplicate alerts.

### 5) A dev-only manual test button in the Tasks screen
Updated `app/(tabs)/tasks.tsx` to include two dev-only buttons (Android only):
- **Test alarm (+2 min)**: schedules an alarm ~2 minutes in the future (uid `debug-alarm`)
- **Stop test alarm**: stops any currently playing alarm and removes the debug alarm

Visibility:
- Only shows when `__DEV__ === true`
- Only shows on Android (`Platform.OS === 'android'`)

---

## Intention / scope (MVP)

This is an MVP approach to get as close as possible to a **real alarm clock experience**:
- Date + time specific alarms for tasks
- Alarm scheduled at task due datetime
- Plays even if the app is not open (library claims it supports boot persistence via BootReceiver)

What this MVP does **not** fully guarantee:
- Absolute precision on all OEMs and OS versions (Android has battery/exact-alarm policies)
- Guaranteed behavior when user disables “Alarms & reminders” / notification permissions
- Perfect emulator parity (real devices behave differently for alarms/audio/lockscreen)

---

## How to build / run the project (macOS, Android Studio emulator)

### 1) Fix Gradle wrapper permissions (one-time)
If `expo run:android` fails with `EACCES` for `android/gradlew`, run:

```bash
cd android
chmod +x gradlew
cd ..
```

### 2) Ensure Java is available
Gradle requires a JDK. If you installed Android Studio, you can use its bundled JDK.

Android Studio typically includes it at:

```text
/Applications/Android Studio.app/Contents/jbr/Contents/Home
```

Run builds using:

```bash
export JAVA_HOME="/Applications/Android Studio.app/Contents/jbr/Contents/Home"
export PATH="$JAVA_HOME/bin:$PATH"
java -version
```

### 3) Ensure Android SDK location is configured
Gradle needs to know where the Android SDK is. On macOS it’s usually:

```text
~/Library/Android/sdk
```

We added `android/local.properties` with:

```text
sdk.dir=/Users/<your-user>/Library/Android/sdk
```

If the path is different on your machine, update `android/local.properties`.

### 4) Start an emulator
In Android Studio:
- **More Actions → Virtual Device Manager**
- Create/start an emulator (prefer a Google Play image if available)

### 5) Build & install on the emulator
From repo root:

```bash
npm install
export JAVA_HOME="/Applications/Android Studio.app/Contents/jbr/Contents/Home"
export PATH="$JAVA_HOME/bin:$PATH"
npx expo run:android
```

Notes:
- `expo run:android` uses Gradle (`android/gradlew`) under the hood.
- The first build may download Gradle + dependencies and take a while.

---

## Manual testing checklist

### A) Quick “is the library wired?” smoke test
1. Launch the app on the emulator/device
2. Go to **Tasks**
3. Tap **Test alarm (+2 min)**
4. Lock the screen and wait ~2 minutes
5. Confirm the alarm UI/sound happens

To stop it:
- Tap **Stop test alarm**

### B) Task-based alarm test
1. Create a task due **2–5 minutes from now**
2. Toggle **Alarm Enabled**
3. Save
4. Wait for the due time

### C) Reboot persistence test (real device recommended)
Emulators can be inconsistent here.
1. Create a task due **10 minutes from now** with Alarm Enabled
2. Reboot the device (or emulator)
3. Do **not** open the app
4. Confirm the alarm still fires

---

## Local/dev environment variables (Stripe note)

The app previously had a hardcoded Stripe publishable key fallback in `app/_layout.tsx`.
That fallback was removed; Stripe is now **optional**:
- If `EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY` is not set, the app will run with payments disabled.

This makes local testing possible without Stripe credentials.

---

## If builds fail

Most common build issues:
- `android/gradlew EACCES` → run `chmod +x android/gradlew`
- “Unable to locate a Java Runtime” → set `JAVA_HOME` (see above)
- “SDK location not found” → set `android/local.properties` `sdk.dir=...`

For any other Gradle error, capture the final ~50 lines of the build output and share it.

---

## Legal disclaimer (AI-generated contribution)

This document and the related code changes were generated with AI assistance. As the human co-author, **Jesper Hodge** (and **AI4U**) provide this material **“as is”**, without warranties of any kind, express or implied.

**Jesper Hodge and AI4U accept no responsibility or liability** for any faults, defects, outages, data loss, security vulnerabilities, compliance failures, or other damages arising from:
- copying or using any part of this document or code **1:1**, or
- implementing these changes without independent engineering judgment, testing, and security review,
including where such copying/use is contrary to the advice in this document.


